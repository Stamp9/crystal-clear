<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>graph test</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .links line {
            stroke: #999;
            stroke-opacity: 0.6;
        }

        .nodes circle {
            stroke: #fff;
            stroke-width: 1.5px;
            cursor: pointer;
        }

        .node-labels text {
            font-size: 8px;
        }

        .link-labels text {
            font-size: 6px;
        }

        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px;
            border-radius: 3px;
            font-size: 12px;
            pointer-events: none;
        }

        #copyNotification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50;
            color: white;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
    </style>
</head>

<body>
    <svg width="960" height="600"></svg>
    <div class="tooltip" style="opacity: 0;"></div>
    <div id="copyNotification">copied</div>
    <script>
        const svg = d3.select("svg");
        const width = +svg.attr("width");
        const height = +svg.attr("height");
        const tooltip = d3.select(".tooltip");
        const copyNotification = d3.select("#copyNotification");

        const zoom = d3.zoom()
            .scaleExtent([0.1, 10])
            .on("zoom", zoomed);

        svg.call(zoom);

        const g = svg.append("g");

        function zoomed(event) {
            g.attr("transform", event.transform);
        }
        // input data
        const data = "ethereum__traces__19917298_to_19917298.json"
        // const data = "ethereum__traces__0x55a72f_to_0x55a72f.json"
        d3.json(data).then(data => {
            const nodes = new Set();
            const links = [];

            data.forEach(item => {
                nodes.add(item.action_from);
                nodes.add(item.action_to);
                links.push({
                    source: item.action_from,
                    target: item.action_to,
                    type: item.action_call_type
                });
            });

            const nodesArray = Array.from(nodes).map(id => ({ id }));

            const simulation = d3.forceSimulation(nodesArray)
                .force("link", d3.forceLink(links).id(d => d.id).distance(100))
                .force("charge", d3.forceManyBody().strength(-500))
                .force("x", d3.forceX(width / 2).strength(0.1))
                .force("y", d3.forceY(height / 2).strength(0.1));

            const link = g.append("g")
                .attr("class", "links")
                .selectAll("line")
                .data(links)
                .enter().append("line")
                .attr("stroke-width", 2);

            const node = g.append("g")
                .attr("class", "nodes")
                .selectAll("circle")
                .data(nodesArray)
                .enter().append("circle")
                .attr("r", 6)
                .attr("fill", d => d3.schemeCategory10[Math.floor(Math.random() * 10)])
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended))
                .on("mouseover", showNodeTooltip)
                .on("mouseout", hideTooltip)
                .on("click", copyAddress);

            const nodeLabel = g.append("g")
                .attr("class", "node-labels")
                .selectAll("text")
                .data(nodesArray)
                .enter().append("text")
                .text(d => d.id.substr(0, 6) + "...")
                .attr("dx", 8)
                .attr("dy", ".35em");

            const linkLabel = g.append("g")
                .attr("class", "link-labels")
                .selectAll("text")
                .data(links)
                .enter().append("text")
                .text(d => d.type)
                .attr("text-anchor", "middle")
                .on("mouseover", showLinkTooltip)
                .on("mouseout", hideTooltip);

            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y);

                nodeLabel
                    .attr("x", d => d.x)
                    .attr("y", d => d.y);

                linkLabel
                    .attr("x", d => (d.source.x + d.target.x) / 2)
                    .attr("y", d => (d.source.y + d.target.y) / 2);
            });

            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }

            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }

            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }

            function showNodeTooltip(event, d) {
                tooltip.transition()
                    .duration(200)
                    .style("opacity", .9);
                tooltip.html("Address: " + d.id)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
            }

            function showLinkTooltip(event, d) {
                tooltip.transition()
                    .duration(200)
                    .style("opacity", .9);
                tooltip.html("From: " + d.source.id + "<br/>to: " + d.target.id + "<br/>类型: " + d.type)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
            }

            function hideTooltip() {
                tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
            }

            function copyAddress(event, d) {
                navigator.clipboard.writeText(d.id).then(() => {
                    copyNotification.style("display", "block");
                    setTimeout(() => {
                        copyNotification.style("display", "none");
                    }, 2000);
                }).catch(err => {
                    console.error('can not copy: ', err);
                });
            }
        }).catch(error => console.error("error:", error));
    </script>
</body>

</html>